
# Docker 볼륨, 바인딩, 네트워크 (2025/06/19)

### **Chapter 1: 도커 데이터 영속성 (Data Persistence)**

컨테이너는 삭제 시 데이터가 사라지는 문제를 해결하기 위해, 호스트 머신에 데이터를 영구적으로 저장하는 방법이 필요합니다.

#### **1. 데이터 관리 방식: 볼륨 vs. 바인드 마운트**

도커는 데이터를 영속화하기 위한 두 가지 주요 메커니즘을 제공합니다.

| 구분 | Docker 볼륨 (Volumes) | 바인드 마운트 (Bind Mounts) |
| :--- | :--- | :--- |
| **데이터 저장 위치** | 도커 관리 영역 (`/var/lib/docker/volumes`) | 호스트의 모든 경로 |
| **관리 주체** | **도커 (Docker)** - `docker volume` 명령어로 관리 | **사용자/호스트 (OS)** - OS 명령어로 관리 |
| **주요 용도** | 데이터베이스, 설정 파일 등 **데이터 영속화** | 개발 환경의 **소스 코드 동기화** |
| **초기화 동작** | 볼륨이 비어있으면, 컨테이너 데이터를 볼륨으로 복사 | 호스트 디렉터리가 컨테이너 디렉터리를 덮어씀 |
| **이식성** | **높음** (볼륨 이름만으로 관리) | **낮음** (호스트의 특정 경로에 의존) |

##### **볼륨 작동 방식 다이어그램**

```
      [ Docker 컨테이너 ]                           [ Docker 호스트 ]
┌─────────────────────────┐                   ┌──────────────────────────────────┐
│                         │                   │                                  │
│  /usr/share/nginx/html  │ <-----(마운트)----> │ /var/lib/docker/volumes/myvol/_data │
│      (컨테이너 경로)      │    (데이터 동기화)    │         (도커 관리 영역)         │
│                         │                   │                                  │
└─────────────────────────┘                   └──────────────────────────────────┘
```

##### **바인드 마운트 작동 방식 다이어그램**

```
      [ Docker 컨테이너 ]                           [ Docker 호스트 ]
┌─────────────────────────┐                   ┌──────────────────────────────────┐
│                         │                   │                                  │
│  /usr/src/app           │ <-----(직접 매핑)----> │  /home/dev/my-project/src      │
│      (컨테이너 경로)      │                   │      (호스트의 모든 경로 가능)     │
│                         │                   │                                  │
└─────────────────────────┘                   └──────────────────────────────────┘
```

#### **2. 실습: 볼륨과 바인드 마운트 활용**

##### **예제 1: Nginx 웹 서버에 볼륨 적용하기**

1.  **볼륨 생성**: `nginx-vol`이라는 이름의 볼륨을 생성합니다.

    ```bash
    docker volume create nginx-vol
    ```

2.  **컨테이너 실행 및 볼륨 연결**: `-v` 옵션을 사용하여 볼륨을 Nginx의 웹 문서 경로에 연결합니다.

    ```bash
    docker run -d --name myweb -v nginx-vol:/usr/share/nginx/html -p 8080:80 nginx
    ```

3.  **데이터 변경 및 확인**: 호스트에서 볼륨의 `index.html` 파일을 직접 수정하면, 웹 페이지 내용이 즉시 변경됩니다.

    ```bash
    echo '<h1>Hello from Docker Volume!</h1>' > /var/lib/docker/volumes/nginx-vol/_data/index.html
    ```

##### **예제 2: 개발 환경에서 소스 코드 공유 (바인드 마운트)**

1.  **호스트에 작업 디렉터리 생성**:

    ```bash
    mkdir -p /source/my-app
    echo '<h1>Live Reload with Bind Mounts</h1>' > /source/my-app/index.html
    ```

2.  **컨테이너 실행 및 바인드 마운트 연결**:

    ```bash
    docker container run -d --name dev-server -v /source/my-app:/usr/share/nginx/html -p 8081:80 nginx
    ```

    이제 호스트에서 `/source/my-app` 폴더의 코드를 수정하면, 별도의 배포 과정 없이 웹 서버에 즉시 반영되어 개발 효율이 크게 향상됩니다.

-----

### **Chapter 2: 도커 네트워크 운영 (Network Operations)**

#### **1. Docker 네트워크 드라이버 유형**

| 드라이버 | 설명 | 주요 사용 사례 |
| :--- | :--- | :--- |
| **`bridge`** | **(기본값)** 호스트 내에 가상 브리지(`docker0`)를 생성하여 컨테이너들을 사설망으로 연결합니다. | 단일 호스트 내에서 여러 컨테이너가 통신하는 가장 일반적인 환경입니다. |
| **`host`** | 컨테이너가 호스트의 네트워크를 그대로 사용합니다. 네트워크 격리가 없습니다. | 네트워크 성능이 매우 중요하거나, 컨테이너가 호스트의 서비스를 직접 사용해야 할 때 유용합니다. |
| **`none`** | 컨테이너에 루프백(`lo`) 인터페이스만 할당하여 네트워크를 완전히 격리합니다. | 네트워크가 필요 없는 배치 작업이나 보안이 중요한 작업에 적합합니다. |

##### **기본 브리지 네트워크 (`docker0`) 구조**

```
+------------------+     +--------------------------+     +-------------------+
|    컨테이너 A     |     |       도커 호스트          |     |     외부 네트워크     |
| (172.17.0.2)     |<--->|  docker0 (172.17.0.1)  |<--->|   ens33 (호스트 IP)  |
+------------------+     | (가상 브리지 / 게이트웨이) |     | (예: 인터넷)      |
|    컨테이너 B     |     +--------------------------+     +-------------------+
| (172.17.0.3)     |
+------------------+
```

#### **2. 사용자 정의 브리지 네트워크**

애플리케이션별로 네트워크를 분리하여 보안을 강화하고, 컨테이너 이름 기반의 통신을 가능하게 합니다.

##### **주요 명령어**

| 명령어 | 설명 |
| :--- | :--- |
| `docker network create <네트워크명>` | 새로운 브리지 네트워크를 생성합니다. |
| `docker network ls` | 생성된 네트워크 목록을 확인합니다. |
| `docker network inspect <네트워크명>`| 네트워크의 상세 정보(서브넷, 게이트웨이 등)를 확인합니다. |
| `docker network connect <네트워크명> <컨테이너명>` | 실행 중인 컨테이너를 다른 네트워크에 추가로 연결합니다. |
| `docker network rm <네트워크명>` | 사용하지 않는 네트워크를 삭제합니다. |

##### **실습 예제: 사용자 정의 네트워크를 이용한 웹-DB 연동**

1.  **애플리케이션용 네트워크 생성**:

    ```bash
    docker network create web-db-net
    ```

2.  **각 컨테이너를 생성된 네트워크에 연결하여 실행**:

    ```bash
    # DB 컨테이너 실행
    docker run -d --name database --network web-db-net -e MYSQL_ROOT_PASSWORD=pass mysql:5.7

    # 웹 애플리케이션 컨테이너 실행
    docker run -d --name webapp --network web-db-net -p 8080:80 my-webapp-image
    ```

      * 이제 `webapp` 컨테이너는 IP 주소 대신 `database`라는 **컨테이너 이름**으로 DB에 접속할 수 있습니다. 이는 도커가 제공하는 내부 DNS 덕분입니다.

#### **3. 컨테이너 네트워크 옵션**

| 플래그 | 설명 | 예시 |
| :--- | :--- | :--- |
| **`--hostname`** | 컨테이너의 호스트 이름을 설정합니다. | `... --hostname my-server centos:8` |
| **`--dns`** | 컨테이너가 사용할 DNS 서버를 지정합니다. | `... --dns=1.1.1.1 centos:8` |
| **`--add-host`** | 컨테이너의 `/etc/hosts` 파일에 특정 호스트 정보를 추가합니다. | `... --add-host api.server:10.0.0.5 centos:8` |

-----

### **Chapter 3: 컨테이너 리소스 제어와 관리**

#### **1. 리소스 제한의 중요성**

  - 기본적으로 컨테이너는 호스트의 모든 하드웨어 자원(CPU, 메모리)을 제한 없이 사용할 수 있습니다.
  - 특정 컨테이너의 리소스 과다 사용이 다른 컨테이너의 성능에 영향을 미치는 것을 방지하기 위해, 리소스 제한은 필수적입니다.

#### **2. 주요 리소스 제한 옵션 (`docker run`)**

| 리소스 | 플래그 | 설명 | 예시 |
| :--- | :--- | :--- | :--- |
| **메모리** | `-m` 또는 `--memory` | 컨테이너가 사용할 수 있는 최대 메모리를 설정합니다. | `-m 512m` |
| **CPU** | `--cpus` | 사용 가능한 CPU 코어 수를 제한합니다. (예: 1.5개) | `--cpus="1.5"` |
| **블록 I/O** | `--device-write-bps`| 디스크 쓰기 속도를 제한합니다. (초당 바이트) | `--device-write-bps /dev/sda:1mb` |

##### **리소스 제한 예시**

```bash
# CPU 코어를 1개로, 메모리를 1GB로 제한하여 Nginx 컨테이너 실행
docker run -d --name limited-nginx --cpus="1" -m 1g -p 8082:80 nginx
```

#### **3. 컨테이너 관리 주요 명령어**

| 명령어 | 설명 |
| :--- | :--- |
| `docker container stats` | 실행 중인 컨테이너들의 CPU, 메모리, 네트워크 사용량을 실시간으로 보여줍니다. |
| `docker container top <컨테이너명>` | 컨테이너 내부에서 실행 중인 프로세스 목록을 확인합니다. |
| `docker container logs -f <컨테이너명>` | 컨테이너의 로그를 실시간으로 스트리밍합니다. |
| `docker container cp <src_path> <dest_path>` | 호스트와 컨테이너 간에 파일을 복사합니다. |
| `docker container diff <컨테이너명>` | 컨테이너 파일 시스템의 변경 사항(추가, 변경, 삭제)을 확인합니다. |
